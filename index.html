<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gerador WhatsApp de Afiliados</title>
  <meta name="description" content="Cole o link encurtado de afiliados e gere o texto pronto para WhatsApp.">
  <style>
    :root{
      --bg:#0b1020; --card:#0f172a; --text:#e6eeff; --muted:#9fb0cf;
      --border:#1e293b; --primary:#6ea8fe; --accent:#22c55e;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font:16px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;
      background: radial-gradient(1200px 600px at 10% -10%, #1a2452 0%, #0b1020 48%, #0b1020 100%);
      display:flex; align-items:flex-start; justify-content:center;
    }
    .wrap{width:100%; max-width:1000px; padding:28px 16px 64px}
    .hero{text-align:center; margin-bottom:18px;}
    .title{font-size:28px; font-weight:800; margin:0 0 10px; letter-spacing:.2px;}
    .subtitle{color:var(--muted); margin:0}
    .bar{margin:18px auto 0; display:flex; gap:10px; justify-content:center; flex-wrap:wrap; max-width:820px;}
    .input{flex:1; min-width:260px; max-width:620px; background:#0d1226; color:#fff; border:1px solid var(--border); padding:14px; border-radius:14px; outline:none}
    .btn{padding:14px 18px; border-radius:14px; border:1px solid #274269; background:linear-gradient(180deg,#3b82f6,#1d4ed8); color:#fff; cursor:pointer; transition:transform .08s ease}
    .btn:hover{transform:translateY(-1px)}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); border:1px solid var(--border); border-radius:18px; padding:18px; box-shadow:0 12px 40px rgba(0,0,0,.35);}
    .editor{margin-top:18px; display:grid; gap:18px; grid-template-columns: 320px 1fr; align-items:start;}
    @media (max-width:900px){ .editor{grid-template-columns:1fr} }
    .media{background:#0d1326; border:1px solid var(--border); border-radius:16px; width:100%; aspect-ratio:1/1; display:flex; align-items:center; justify-content:center; overflow:hidden}
    .media img{max-width:100%; max-height:100%; width:auto; height:auto; object-fit:contain; display:block}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .field{flex:1; min-width:220px; background:#0d1226; border:1px solid var(--border); color:#fff; border-radius:12px; padding:12px; outline:none}
    .wide{width:100%}
    .hint{color:var(--muted); font-size:13px}
    .actions{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .btn.secondary{background:linear-gradient(180deg,#22c55e,#16a34a); border-color:#138a3f;}
    .btn.ghost{background:transparent; border:1px dashed var(--border); color:#cbd5e1}
    .pill{border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-size:13px; color:#c9d6f2}
    .preview{white-space:pre-wrap; background:#0b1224; border:1px dashed var(--border); border-radius:12px; padding:12px; margin-top:10px; color:#d9e6ff}
    .small{font-size:12px; color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <h1 class="title">Gerador WhatsApp de Afiliados</h1>
      <p class="subtitle">Cole o <b>link encurtado</b> do seu painel (amzn.to, mercadolivre.com/sec, shopee encurtado‚Ä¶) e gere o texto pronto.</p>
      <div class="bar">
        <input id="url" class="input" placeholder="Cole aqui o link encurtado‚Ä¶" />
        <button id="parse" class="btn">Extrair dados</button>
      </div>
      <p class="hint" style="margin-top:10px">Usamos o link encurtado <b>do jeito que est√°</b> para compartilhar (preserva seu tracking). A expans√£o serve s√≥ para coletar t√≠tulo/pre√ßo/imagem.</p>
    </div>

    <div class="card editor">
      <div class="media"><img id="img" alt="Imagem do produto"></div>
      <div>
        <div class="row">
          <input id="store" class="field" placeholder="Loja (ex.: Amazon)" style="max-width:250px" />
          <input id="emoji" class="field" placeholder="Emoji (ex.: üî•)" style="max-width:140px" />
          <input id="badge" class="field" placeholder="Selo (ex.: Amazon)" style="max-width:250px" />
        </div>
        <input id="title" class="field wide" placeholder="T√≠tulo do produto" />
        <div class="row">
          <input id="oldPrice" class="field" placeholder="Pre√ßo antigo (ex.: 569,00)" style="max-width:260px" />
          <input id="price" class="field" placeholder="Pre√ßo atual (ex.: 549,00)" style="max-width:260px" />
          <input id="installment" class="field" placeholder="Parcelas (ex.: 6x R$ 43,71 sem juros)" />
        </div>
        <input id="image" class="field wide" placeholder="URL da imagem" />
        <div class="row">
          <input id="shareUrl" class="field" placeholder="Link para compartilhar (encurtado do seu painel)" />
          <input id="finalUrl" class="field" placeholder="URL expandida (refer√™ncia)" />
        </div>
        <div class="actions">
          <button id="gen" class="btn secondary">Gerar texto e abrir WhatsApp</button>
          <button id="copy" class="btn ghost">Copiar texto</button>
          <button id="previewBtn" class="btn ghost">Pr√©via</button>
          <span id="hint" class="pill">pronto</span>
        </div>
        <div class="preview small" id="preview" style="display:none"></div>
      </div>
    </div>
  </div>

  <script>
    const el = (id) => document.getElementById(id);
    const set = (id, v) => { el(id).value = v ?? ""; };
    const currency = (v) => {
      if (v === null || v === undefined || v === "") return "";
      const n = typeof v === "number" ? v : parseFloat(String(v).replace(/[^\d,.-]/g, "").replace(",", "."));
      if (isNaN(n)) return String(v);
      return n.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    };

    // Normaliza "6x de R$ 36,50 sem juros" -> "üí≥ 6X R$36,50"
    const normalizeInstallment = (s) => {
      if (!s) return "";
      const q = (s.match(/(\d{1,2})\s*x/i) || [])[1];
      let amt = (s.match(/(\d{1,3}(?:\.\d{3})*,\d{2})/) || [])[1];
      if (!amt) {
        const n = parseFloat(String(s).replace(/[^\d,.-]/g, "").replace(",", "."));
        if (Number.isFinite(n)) amt = n.toLocaleString("pt-BR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }
      if (!q || !amt) return "";
      return `üí≥ ${q.toUpperCase()}X R$${amt.replace(/^R\$\s*/i, "")}`;
    };

    const buildText = () => {
      const store = el("store").value || "Mercado Livre";
      const emoji = el("emoji").value || "üî•";
      const title = el("title").value || "";
      const oldPrice = el("oldPrice").value || "";
      const price = el("price").value || "";
      const installmentRaw = el("installment").value || "";
      const share = el("shareUrl").value || el("url").value || "";

      const installment = normalizeInstallment(installmentRaw);

      const lines = [];
      lines.push(store);
      lines.push(`${emoji} ${title}`);
      lines.push("");
      if (oldPrice) lines.push(`‚ùå ${currency(oldPrice)}`);
      if (price)    lines.push(`‚úÖ ${currency(price)}`);
      if (installment) lines.push(installment);
      lines.push("");
      if (share) lines.push(share);

      return lines.join("\n");
    };

    const showPreview = () => {
      const p = el("preview");
      p.textContent = buildText();
      p.style.display = "block";
    };
    const setHint = (msg) => { el("hint").textContent = msg; };

    el("previewBtn").onclick = showPreview;

    el("copy").onclick = async () => {
      try { await navigator.clipboard.writeText(buildText()); setHint("copiado"); } catch { setHint("falha ao copiar"); }
      showPreview();
    };

    el("gen").onclick = () => {
      const txt = buildText();
      navigator.clipboard?.writeText(txt).catch(()=>{});
      const wa = `https://wa.me/?text=${encodeURIComponent(txt)}`;
      window.open(wa, "_blank", "noopener");
    };

    el("parse").onclick = async () => {
      const url = el("url").value.trim();
      if (!url) { alert("Cole o link encurtado do seu painel."); return; }
      setHint("buscando...");
      try{
        const res = await fetch(`/api/parse?url=${encodeURIComponent(url)}`);
        const data = await res.json();

        set("store", data.store || "");
        set("badge", data.store || "");
        set("emoji", "üî•");
        set("title", data.title || "");
        set("oldPrice", data.oldPrice ?? "");
        set("price", data.price ?? "");
        set("installment", data.installment || "");
        set("image", data.image || "");
        set("shareUrl", data.shareUrl || url);
        set("finalUrl", data.finalUrl || "");
        if (data.image) el("img").src = data.image; else el("img").removeAttribute("src");

        setHint(data.parseHint ? `ok (${data.parseHint})` : "ok");
        showPreview();
      }catch(e){
        setHint("erro");
        alert("N√£o consegui extrair automaticamente. Voc√™ pode preencher os campos manualmente.\n\n" + (e.message || e));
      }
    };
  </script>
</body>
</html>
